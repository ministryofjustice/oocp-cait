{% extends "templates/base/base.html" %}
{% import "components/Utils/Utils.njk" as Utils with context %}
{% from 'components/Breadcrumbs/Breadcrumbs.njk' import Breadcrumbs with context %}

{{ Utils.registerBlocks([
  "components/FeedbackBanner/FeedbackBanner.njk",
  "components/CallToAction/CallToAction.njk",
  "components/Costs/Costs.njk",
  "components/ProsCons/ProsCons.njk",
  "components/SectionArea/SectionArea.njk",
  "components/SectionResources/SectionResources.njk",
  "components/SectionVideo/SectionVideo.njk",
  "components/Step/Step.njk",
  "components/CookieSection/CookieSection.njk",
  "components/CookieMessage/CookieMessage.njk"
]) }}

{% block body_classes %}{{ route.template }}{% if req.disqualified %} disqualified{% endif %}{% endblock %}

{% block proposition_name %}{{ Block.String('string:service-name') }}{% endblock %}

{% block stylesheet %}
{{ super() }}
<link href="/public/stylesheets/app.css" rel="stylesheet">
{% endblock %}

{%block cookie_message %}
{% if not req.disqualified %}
{{ Block.CookieMessage() }}
{% endif %}
{% endblock %}

{% block after_header %}
{% if not req.disqualified %}
{{ Block.FeedbackBanner() }}
{% endif %}
{% endblock %}

{% block phase_banner %}
{% if not req.disqualified %}
{% if getString('string:app-phase') %}
<div class="gv-c-phase-banner">
  <p class="gv-c-phase-banner__content">
    <strong class="gv-c-phase-tag">{{ Block.String('string:app-phase') }}</strong>
    <span class="gv-c-phase-banner__text">{{ Block.String('string:app-phase-text') | safe }}</span>
  </p>
</div>
{% endif %}
{% endif %}
{% endblock %}
{#{{ govuk.phaseBanner(
    phase = 'beta',
    message = 'This is the first version of a new service'
) }}#}

{% block breadcrumbs_content %}
{% if route.breadcrumbs %}
{{ Breadcrumbs(route) }}
{% endif %}
{% endblock %}

{% block footer_support_links %}
  {% if not req.disqualified %}
  <h2 class="visuallyhidden">{{ Block.String('string:SupportLinks_heading') }}</h2>
  {% set supportLinks = getElementProp('SupportLinks', 'links') %}
  <ul data-element-block="SupportLinks">
  {% for link in supportLinks %}
  <li{% if link.type %} data-link-type="{{ link.type }}"{% endif %}{% if link.className %} class="{{ link.className }}"{% endif %}>
    {% if link.route %}
      <a href="{{ getRouteUrl(link.route) }}">{{ getElementProp(link.route, 'heading') }}</a>
    {% else %}
      {{ markdown(link.link) | safe }}
    {% endif %}
  </li>
  {% endfor %}
  </ul>
  {% endif %}
{% endblock %}

{% block body_end %}
{{ super() }}
{# TODO: ensure that req.disqualified does what it should do #}
{# TODO: normalize env, ENV, req.env, req.ENV #}
{% if not req.disqualified %}
  <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha256-/SIrNqv8h6QGKDuNoLGA4iret+kyesCkHGzVUUV0shc=" crossorigin="anonymous"></script>
  <script src="/public/javascripts/vendor/js-cookie/js-cookie_v2.1.3.js"></script>
  <script>
  if (Cookies.get('seen_cookie_message')) {
    jQuery('#global-cookie-message').addClass('cookie-seen')
  }
  Cookies.set('seen_cookie_message', true, { expires: 28 })
  </script>
  <script>
  var searchArgs = {}
  var search = document.location.search
  if (search) {
    search = search.replace(/^\?/, '')
    var searchChunks = search.split('&')
    for (var i = 0, sLength = searchChunks.length; i < sLength; i++) {
      var argParts = searchChunks[i].split('=')
      searchArgs[argParts[0]] = argParts[1]
    }
  }
  var surveyData = Cookies.getJSON('surveyData') || {}
  surveyData.visited = surveyData.visited || {}
  if (!surveyData.uuid && searchArgs.uuid) {
    surveyData.uuid = searchArgs.uuid
  }
  window.setValues = {}
  window.setValues.dimension12 = surveyData.uuid
  {% if env.APP_VERSION %}
  var APP_VERSION = '{{ env.APP_VERSION }}'
  window.setValues.dimension13 = APP_VERSION
  {% endif %}
  var campaignFields = ['campaignName', 'campaignMedium', 'campaignKeyword', 'campaignContent', 'campaignID']
  for (var j = 0; j < campaignFields.length; j++) {
    var campaignField = campaignFields[j]
    if (searchArgs[campaignField]) {
      surveyData[campaignField] = searchArgs[campaignField]
      window.setValues[campaignField] = searchArgs[campaignField]
    }
  }

  {% if page.type != 'about' %}
  var pageStub = document.location.pathname
                  .replace(/\/$/, '')
                  .replace(/.*\//, '')
                  || 'summary'
  surveyData.visited[pageStub] = true
  {% endif %}
  Cookies.set('surveyData', surveyData)

  var visited = []
  for (var page in surveyData.visited) {
    visited.push(page)
  }


  jQuery('.moj-FeedbackBanner__link a').attr('data-link-type', 'feedback-banner')
  jQuery('a[data-link-type="feedback"], [data-link-type="footer-feedback"] a, a[data-link-type="feedback-banner"]').each(function(){
    var addition = '?uuid=' + surveyData.uuid
    jQuery.each(visited, function(i, page) {
      addition += '&' + page.replace(/-/g, '_') + '=T'
    })
  // TODO: make this a match and recheck
  {% if ENV != 'prod' %}
    this.href = this.href.replace(/3DXCX9L/, 'W6KHC6C')
  {% endif %}
    this.href += addition
  })
  </script>
  {% if env.GA_TRACKING_ID %}
  <script>
  var GA_TRACKING_ID = '{{ env.GA_TRACKING_ID }}'
  </script>
  <script src="/public/javascripts/ga-custom/ga-custom.js"></script>
  <script async src="https://www.google-analytics.com/analytics.js"></script>
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=IntersectionObserver"></script>
  <script src="/public/javascripts/vendor/autotrack/autotrack_v2.0.4.js"></script>
  <script src="/public/javascripts/ga-plugins/ga-plugins.js"></script>
  <script>
  jQuery('.gv-c-button').each(function() {
    jQuery(this).attr('data-link-type', 'button')
  })
  </script>
  <script src="/public/javascripts/tracking-video/tracking-video.js"></script>
  <script src="/public/javascripts/tracking-element/tracking-element.js"></script>
  {% endif %}
{% endif %}
{% endblock %}